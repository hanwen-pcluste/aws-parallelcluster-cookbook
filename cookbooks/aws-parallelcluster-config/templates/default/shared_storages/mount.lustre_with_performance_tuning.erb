#!/bin/bash

# Copyright 2013-2023 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License"). You may not use this file except in compliance with the
# License. A copy of the License is located at
#
# http://aws.amazon.com/apache2.0/
#
# or in the "LICENSE.txt" file accompanying this file. This file is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES
# OR CONDITIONS OF ANY KIND, express or implied. See the License for the specific language governing permissions and
# limitations under the License.

set -ex

if [ $(ohai cpu/total) -gt 64 ] && (! (/sbin/lsmod | grep -q ^lustre) || [ $(/sbin/lsmod | grep ^lustre | awk '{print $3}') -eq 0 ]); then
  modprobe_conf_path="/etc/modprobe.d/modprobe.conf"
  ptlrpcd_per_cpt_max="options ptlrpc ptlrpcd_per_cpt_max"
  ksocklnd_credits="options ksocklnd credits"
  if ! grep -q "$ptlrpcd_per_cpt_max" "$modprobe_conf_path" && ! grep -q "$ksocklnd_credits" "$modprobe_conf_path"; then
    sudo sh -c "echo $ptlrpcd_per_cpt_max=32 >> /etc/modprobe.d/modprobe.conf"
    sudo sh -c "echo $ksocklnd_credits=2560 >> /etc/modprobe.d/modprobe.conf"
    # Reload Lustre kernel module to apply the above two settings
    sudo lustre_rmmod && sudo modprobe lustre
  fi
fi

sudo mount -t lustre "$@"

if [ $(ohai cpu/total) -gt 64 ]; then
  sudo lctl set_param osc.*OST*.max_rpcs_in_flight=32
  sudo lctl set_param mdc.*.max_rpcs_in_flight=64
  sudo lctl set_param mdc.*.max_mod_rpcs_in_flight=50
fi
total_memory_kb=$(cat /proc/meminfo | grep MemTotal | awk '{print $2}')
if [ "$total_memory_kb" -gt 274877907 ]; then
  sudo lctl set_param llite.*.max_cached_mb=$((total_memory_kb/10000)) # set this value to be 10% of customer client instance physical memory in mb
fi